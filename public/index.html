<!DOCTYPE html>
<meta charset="utf-8" />
<title>Zuul-AC User data</title>
<script language="javascript" type="text/javascript">
	let ws_protocol = "ws://"
	if (window.location.protocol == "https:") {
		ws_protocol = "wss://"
	}
	var wsUri = ws_protocol + window.location.hostname + ":" + window.location.port
	var output;
	var users;
	var timetables;

	function init() {
		users = document.getElementById("users");
		timetables = document.getElementById("timetables");
		output = document.getElementById("output");
		testWebSocket();
	}

	function testWebSocket() {
		websocket = new WebSocket(wsUri);
		websocket.onopen = function (evt) { onOpen(evt) };
		websocket.onclose = function (evt) { onClose(evt) };
		websocket.onmessage = function (evt) { onMessage(evt) };
		websocket.onerror = function (evt) { onError(evt) };
	}

	function onOpen(evt) {
		writeToScreen("CONNECTED");
		doSend('{"type":"st_tree","config":""}');
	}

	function onClose(evt) {
		writeToScreen("DISCONNECTED");
	}

	function onMessage(evt) {
		var data = JSON.parse(evt.data)
		writeToScreen('<span style="color: blue;">RESPONSE: ' + evt.data + '</span>');
		websocket.close();
		console.log(data)
		for (var user_id in data.config.users){
			console.log(user_id)
			var li = document.createElement("li");
			var user_info=data.config.users[user_id].user.first_name+' '+data.config.users[user_id].user.last_name+" ("+user_id+") <"+data.config.users[user_id].time_table[0]+">"
			li.appendChild(document.createTextNode(user_info));
			users.appendChild(li);
		}
		var ul = document.createElement("ul");
		for (var user_id in data.config.timetables){
			console.log(user_id)
			var li = document.createElement("li");
			var user_info=data.config.users[user_id].user.first_name+' '+data.config.users[user_id].user.last_name+" ("+user_id+") ["+data.config.timetables[user_id]["1"].deletion_timestamp+"]"
			li.appendChild(document.createTextNode(user_info));
			var sub_ul = document.createElement("ul");
			for (var follower_id in data.config.timetables[user_id]["1"].users){
				var sub_li = document.createElement("li");
				if (data.config.users[follower_id]){
					user_info=data.config.users[follower_id].user.first_name+' '+data.config.users[follower_id].user.last_name+" ("+follower_id+") ["+data.config.timetables[user_id]["1"].users[follower_id]+"]"
				}else{
					user_info="("+follower_id+") ["+data.config.timetables[user_id]["1"].users[follower_id]+"]"
				}
				sub_li.appendChild(document.createTextNode(user_info));
				sub_ul.appendChild(sub_li);
			}
			li.appendChild(sub_ul);
			ul.appendChild(li);
		}
		timetables.appendChild(ul);
	}

	function onError(evt) {
		writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data);
	}

	function doSend(message) {
		//writeToScreen("SENT: " + message);
		websocket.send(message);
	}

	function writeToScreen(message) {
		var pre = document.createElement("p");
		pre.style.wordWrap = "break-word";
		pre.innerHTML = message;
		output.appendChild(pre);
	}

	window.addEventListener("load", init, false);

</script>

<h2>Zuul-AC User data</h2>

<div id="users"><h3>Users</h3></div>
<div id="timetables"><h3>Time Tables</h3></div>
<div id="output"></div>